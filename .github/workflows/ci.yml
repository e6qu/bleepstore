name: CI
on:
  pull_request:
    branches: [main]

jobs:
  python:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: make -C python build
      - run: make -C python fmt-check
      - run: make -C python lint
      - run: make -C python test-unit
      - run: make -C python test-e2e
        timeout-minutes: 5

  golang:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache-dependency-path: golang/go.sum
      - uses: astral-sh/setup-uv@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: make -C golang fmt-check
      - run: make -C golang build
      - run: make -C golang test-unit
      - run: make -C golang test-e2e
        timeout-minutes: 5

  rust:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust
      - uses: astral-sh/setup-uv@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: make -C rust fmt-check
      - run: make -C rust lint
      - run: make -C rust build
      - run: make -C rust test-unit
      - run: make -C rust test-e2e
        timeout-minutes: 5

  zig:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - uses: mlugg/setup-zig@v2
        with:
          version: "0.15.2"
      - uses: astral-sh/setup-uv@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: make -C zig fmt-check
      - run: make -C zig build
      - run: make -C zig test-unit
      - run: make -C zig test-e2e
        timeout-minutes: 5
